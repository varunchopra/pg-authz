{% extends "orgs/settings_base.html" %}

{% block settings_content %}
<div class="stats">
    <div class="stat">
        <div class="stat-value">{{ members|length }}</div>
        <div class="stat-label">Total Members</div>
    </div>
    <div class="stat">
        <div class="stat-value">{{ admin_count }}</div>
        <div class="stat-label">Admins</div>
    </div>
    <div class="stat">
        <div class="stat-value">{{ disabled_count }}</div>
        <div class="stat-label">Disabled</div>
    </div>
</div>

<div class="section">
    <div class="section-header">
        <h2>All Members</h2>
    </div>

    {% if members %}
    <table class="data-table">
        <thead>
            <tr>
                <th>Email</th>
                <th>Role</th>
                <th>Status</th>
                <th>Joined</th>
                <th class="actions">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for member in members %}
            <tr>
                <td>
                    {{ member.email or member.user_id[:8] ~ '...' }}
                    {% if member.user_id == current_user_id %}
                    <span class="badge">You</span>
                    {% endif %}
                </td>
                <td>
                    {% if member.user_id == org.owner_id %}
                    <span class="badge badge-owner">Owner</span>
                    {% elif member.is_admin %}
                    <span class="badge badge-admin">Admin</span>
                    {% else %}
                    <span class="badge badge-member">Member</span>
                    {% endif %}
                </td>
                <td>
                    {% if member.disabled_at %}
                    <span class="status status-disabled">Disabled</span>
                    {% elif member.email_verified_at %}
                    <span class="status status-verified">Verified</span>
                    {% else %}
                    <span class="status status-pending">Unverified</span>
                    {% endif %}
                </td>
                <td class="meta">{{ member.created_at.strftime('%Y-%m-%d') if member.created_at else '-' }}</td>
                <td class="actions">
                    <a href="{{ url_for('views.orgs.user_sessions', org_id=org.org_id, user_id=member.user_id) }}" class="btn btn-sm">Sessions</a>

                    {% if member.user_id != current_user_id and member.user_id != org.owner_id %}
                        {% if member.is_admin %}
                        <form method="post" action="{{ url_for('views.orgs.revoke_admin', org_id=org.org_id, user_id=member.user_id) }}" class="d-inline">
                            <button type="submit" class="btn btn-sm" onclick="return confirm('Revoke admin permission?')">Revoke Admin</button>
                        </form>
                        {% else %}
                        <form method="post" action="{{ url_for('views.orgs.grant_admin', org_id=org.org_id, user_id=member.user_id) }}" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-primary">Make Admin</button>
                        </form>
                        {% endif %}

                        {% if member.disabled_at %}
                        <form method="post" action="{{ url_for('views.orgs.enable_user', org_id=org.org_id, user_id=member.user_id) }}" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-primary">Enable</button>
                        </form>
                        {% else %}
                        <form method="post" action="{{ url_for('views.orgs.disable_user', org_id=org.org_id, user_id=member.user_id) }}" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Disable this user?')">Disable</button>
                        </form>
                        {% endif %}

                        <form action="{{ url_for('views.orgs.remove_member', org_id=org.org_id, member_id=member.user_id) }}" method="post" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Remove this member from the organization?')">Remove</button>
                        </form>

                        {% if not member.disabled_at %}
                        <button type="button" class="btn btn-sm btn-warning" onclick="showImpersonateModal('{{ member.user_id }}', '{{ member.email }}')">Impersonate</button>
                        {% endif %}
                    {% elif member.user_id == org.owner_id %}
                        <span class="text-muted">Owner</span>
                    {% endif %}

                    {% if is_owner and member.user_id != org.owner_id and member.user_id != current_user_id %}
                    <form method="post" action="{{ url_for('views.orgs.transfer_ownership', org_id=org.org_id, user_id=member.user_id) }}" class="d-inline">
                        <button type="submit" class="btn btn-sm" onclick="return confirm('Transfer ownership to this user? You will become an admin.')">Make Owner</button>
                    </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-message">No members found</div>
    {% endif %}
</div>

<div class="section">
    <div class="section-header">
        <h2>Invite Members</h2>
    </div>
    <form action="{{ url_for('views.orgs.create_invite', org_id=org.org_id) }}" method="post" class="invite-form">
        <div class="form-row">
            <div class="form-group">
                <label for="email">Email (optional)</label>
                <input type="email" id="email" name="email" placeholder="Leave empty for anyone with link">
            </div>
            <div class="form-group">
                <label for="role">Role</label>
                <select id="role" name="role">
                    <option value="member">Member</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div class="form-group">
                <label for="expires_days">Expires in</label>
                <select id="expires_days" name="expires_days">
                    <option value="1">1 day</option>
                    <option value="7" selected>7 days</option>
                    <option value="30">30 days</option>
                </select>
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Create Invite Link</button>
    </form>

    {% if invites %}
    <h3 class="mt-3 mb-2">Pending Invites</h3>
    <table class="data-table">
        <thead>
            <tr>
                <th>Email</th>
                <th>Role</th>
                <th>Expires</th>
                <th>Link</th>
            </tr>
        </thead>
        <tbody>
            {% for invite in invites %}
            <tr>
                <td>{{ invite.email or 'Anyone with link' }}</td>
                <td>{{ invite.role }}</td>
                <td class="meta">{{ invite.expires_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>
                    <code class="invite-code">{{ url_for('views.orgs.view_invite', code=invite.code, _external=True) }}</code>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
</div>

<!-- Impersonation Modal -->
<div id="impersonateModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Impersonate User</h3>
            <button type="button" class="modal-close" onclick="hideImpersonateModal()">&times;</button>
        </div>
        <form id="impersonateForm" method="post" action="">
            <div class="modal-body">
                <p>You are about to view the application as <strong id="impersonateEmail"></strong>.</p>
                <p class="text-warning">All actions during impersonation are logged for compliance.</p>
                <div class="form-group">
                    <label for="impersonateReason">Reason (required)</label>
                    <input type="text" id="impersonateReason" name="reason" placeholder="e.g., Support ticket #123, Bug investigation" required>
                    <small class="form-hint">This reason will be recorded in the audit log.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="hideImpersonateModal()">Cancel</button>
                <button type="submit" class="btn btn-warning">Start Impersonation</button>
            </div>
        </form>
    </div>
</div>

<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}
.modal-content {
    background: white;
    border-radius: 8px;
    width: 100%;
    max-width: 480px;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
}
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
}
.modal-header h3 {
    margin: 0;
    font-size: 18px;
}
.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-secondary);
}
.modal-body {
    padding: 20px;
}
.modal-body p {
    margin-bottom: 16px;
}
.modal-footer {
    padding: 16px 20px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 8px;
}
.text-warning {
    color: var(--warning);
    font-size: 13px;
}
.form-hint {
    display: block;
    color: var(--text-secondary);
    font-size: 12px;
    margin-top: 4px;
}
.btn-warning {
    background: var(--warning-light);
    color: white;
    border-color: var(--warning-light);
}
.btn-warning:hover {
    background: var(--warning);
    border-color: var(--warning);
}
</style>

<script>
function showImpersonateModal(userId, email) {
    document.getElementById('impersonateEmail').textContent = email;
    document.getElementById('impersonateForm').action = '{{ url_for("views.orgs.start_impersonation", org_id=org.org_id, user_id="__USER_ID__") }}'.replace('__USER_ID__', userId);
    document.getElementById('impersonateReason').value = '';
    document.getElementById('impersonateModal').style.display = 'flex';
}

function hideImpersonateModal() {
    document.getElementById('impersonateModal').style.display = 'none';
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        hideImpersonateModal();
    }
});

// Close modal on background click
document.getElementById('impersonateModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideImpersonateModal();
    }
});
</script>
{% endblock %}
